<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ventas - ShopTrust</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/inicio"><i class="bi bi-shop"></i> ShopTrust</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="/inicio">Inicio</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/ventas">Ventas</a></li>
                    <li class="nav-item"><a class="nav-link" href="/compras">Compras</a></li>
                    <li class="nav-item"><a class="nav-link" href="/productos">Productos</a></li>
                    <li class="nav-item"><a class="nav-link" href="/clientes">Clientes</a></li>
                    <li class="nav-item"><a class="nav-link" href="/proveedores">Proveedores</a></li>
                    <li class="nav-item"><a class="nav-link" href="/categorias">Categorías</a></li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <span class="nav-link"><i class="bi bi-person-circle"></i> <span sec:authentication="name">Usuario</span></span>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/logout"><i class="bi bi-box-arrow-right"></i> Salir</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-md-8">
                <h2><i class="bi bi-cart-check"></i> Gestión de Ventas</h2>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-success" onclick="mostrarNuevaVenta()">
                    <i class="bi bi-plus-circle"></i> Nueva Venta
                </button>
            </div>
        </div>

        <!-- Pestañas -->
        <ul class="nav nav-tabs mt-3" id="ventasTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="nueva-tab" data-bs-toggle="tab" data-bs-target="#nueva-venta" 
                        type="button" role="tab">Nueva Venta</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="historial-tab" data-bs-toggle="tab" data-bs-target="#historial" 
                        type="button" role="tab">Historial de Ventas</button>
            </li>
        </ul>

        <div class="tab-content mt-3" id="ventasTabContent">
            <!-- TAB: Nueva Venta -->
            <div class="tab-pane fade show active" id="nueva-venta" role="tabpanel">
                <div class="row">
                    <!-- Panel de Búsqueda de Productos -->
                    <div class="col-md-7">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0"><i class="bi bi-search"></i> Buscar Productos</h5>
                            </div>
                            <div class="card-body">
                                <div class="input-group mb-3">
                                    <input type="text" id="buscarProducto" class="form-control" 
                                           placeholder="Buscar por nombre o código...">
                                    <button class="btn btn-outline-secondary" type="button" onclick="buscarProductos()">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>

                                <div id="listaProductos" class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                    <table class="table table-hover table-sm">
                                        <thead class="table-light sticky-top">
                                            <tr>
                                                <th>Código</th>
                                                <th>Producto</th>
                                                <th>Stock</th>
                                                <th>Precio</th>
                                                <th>Acción</th>
                                            </tr>
                                        </thead>
                                        <tbody id="productosBody">
                                            <!-- Se llena con JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Panel del Carrito -->
                    <div class="col-md-5">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="bi bi-cart3"></i> Carrito de Venta</h5>
                            </div>
                            <div class="card-body">
                                <!-- Selección de Cliente -->
                                <div class="mb-3">
                                    <label class="form-label">Cliente (Opcional)</label>
                                    <select id="clienteVenta" class="form-select form-select-sm">
                                        <option value="">Cliente General</option>
                                        <option th:each="cliente : ${clientes}" 
                                                th:value="${cliente.idCliente}"
                                                th:text="${cliente.nombreCompleto}"></option>
                                    </select>
                                </div>

                                <!-- Método de Pago -->
                                <div class="mb-3">
                                    <label class="form-label">Método de Pago</label>
                                    <select id="metodoPago" class="form-select form-select-sm">
                                        <option value="EFECTIVO">Efectivo</option>
                                        <option value="TARJETA">Tarjeta</option>
                                        <option value="TRANSFERENCIA">Transferencia</option>
                                    </select>
                                </div>

                                <!-- Items del Carrito -->
                                <div id="carritoItems" style="max-height: 200px; overflow-y: auto;">
                                    <p class="text-muted text-center" id="carritoVacio">El carrito está vacío</p>
                                </div>

                                <!-- Totales -->
                                <hr>
                                <div class="row mb-2">
                                    <div class="col">Subtotal:</div>
                                    <div class="col text-end"><strong id="subtotalCarrito">S/ 0.00</strong></div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col">IGV (18%):</div>
                                    <div class="col text-end"><strong id="igvCarrito">S/ 0.00</strong></div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col"><h5>Total:</h5></div>
                                    <div class="col text-end"><h5 class="text-success" id="totalCarrito">S/ 0.00</h5></div>
                                </div>

                                <!-- Botones -->
                                <div class="d-grid gap-2">
                                    <button class="btn btn-success" onclick="procesarVenta()" id="btnProcesar">
                                        <i class="bi bi-check-circle"></i> Procesar Venta
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="limpiarCarrito()">
                                        <i class="bi bi-x-circle"></i> Limpiar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: Historial de Ventas -->
            <div class="tab-pane fade" id="historial" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <div class="row">
                            <div class="col-md-6">
                                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Historial de Ventas</h5>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group input-group-sm">
                                    <input type="date" id="fechaInicio" class="form-control">
                                    <input type="date" id="fechaFin" class="form-control">
                                    <button class="btn btn-primary" onclick="filtrarPorFecha()">
                                        <i class="bi bi-filter"></i> Filtrar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>N° Venta</th>
                                        <th>Fecha</th>
                                        <th>Cliente</th>
                                        <th>Total</th>
                                        <th>Método Pago</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="historialVentas">
                                    <!-- Se llena con JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ver Detalles -->
    <div class="modal fade" id="modalDetalles" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="bi bi-receipt"></i> Detalles de Venta</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detallesVentaBody">
                    <!-- Se llena con JS -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables globales
        let carrito = [];
        let productos = [];

        // Cargar datos iniciales
        document.addEventListener('DOMContentLoaded', function() {
            cargarProductos();
            cargarHistorialVentas();
            
            // Establecer fecha de hoy en filtros
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('fechaInicio').value = hoy;
            document.getElementById('fechaFin').value = hoy;
        });

        // Cargar productos
        function cargarProductos() {
            fetch('/productos/api')
                .then(response => response.json())
                .then(data => {
                    productos = data.filter(p => p.activo && p.stockActual > 0);
                    mostrarProductos(productos);
                });
        }

        // Mostrar productos en tabla
        function mostrarProductos(lista) {
            const tbody = document.getElementById('productosBody');
            tbody.innerHTML = '';

            lista.forEach(producto => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${producto.codigoProducto}</td>
                    <td>${producto.nombreProducto}</td>
                    <td><span class="badge ${producto.stockActual <= producto.stockMinimo ? 'bg-warning' : 'bg-success'}">${producto.stockActual}</span></td>
                    <td>S/ ${producto.precioVenta.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="agregarAlCarrito(${producto.idProducto})">
                            <i class="bi bi-plus"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Buscar productos
        function buscarProductos() {
            const termino = document.getElementById('buscarProducto').value.toLowerCase();
            const filtrados = productos.filter(p => 
                p.nombreProducto.toLowerCase().includes(termino) ||
                p.codigoProducto.toLowerCase().includes(termino)
            );
            mostrarProductos(filtrados);
        }

        // Agregar producto al carrito
        function agregarAlCarrito(idProducto) {
            const producto = productos.find(p => p.idProducto === idProducto);
            if (!producto) return;

            const itemExistente = carrito.find(item => item.idProducto === idProducto);
            
            if (itemExistente) {
                if (itemExistente.cantidad < producto.stockActual) {
                    itemExistente.cantidad++;
                } else {
                    alert('No hay suficiente stock disponible');
                    return;
                }
            } else {
                carrito.push({
                    idProducto: producto.idProducto,
                    nombreProducto: producto.nombreProducto,
                    precioUnitario: producto.precioVenta,
                    cantidad: 1,
                    stockDisponible: producto.stockActual
                });
            }

            actualizarCarrito();
        }

        // Actualizar carrito
        function actualizarCarrito() {
            const container = document.getElementById('carritoItems');
            const carritoVacio = document.getElementById('carritoVacio');

            if (carrito.length === 0) {
                carritoVacio.style.display = 'block';
                container.innerHTML = '<p class="text-muted text-center" id="carritoVacio">El carrito está vacío</p>';
            } else {
                carritoVacio.style.display = 'none';
                container.innerHTML = '';

                carrito.forEach((item, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'border-bottom pb-2 mb-2';
                    itemDiv.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="flex-grow-1">
                                <small><strong>${item.nombreProducto}</strong></small><br>
                                <small class="text-muted">S/ ${item.precioUnitario.toFixed(2)} c/u</small>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <button class="btn btn-sm btn-outline-secondary" onclick="cambiarCantidad(${index}, -1)">-</button>
                                <span class="badge bg-secondary">${item.cantidad}</span>
                                <button class="btn btn-sm btn-outline-secondary" onclick="cambiarCantidad(${index}, 1)">+</button>
                                <button class="btn btn-sm btn-danger" onclick="eliminarDelCarrito(${index})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="text-end mt-1">
                            <strong>S/ ${(item.cantidad * item.precioUnitario).toFixed(2)}</strong>
                        </div>
                    `;
                    container.appendChild(itemDiv);
                });
            }

            calcularTotales();
        }

        // Cambiar cantidad
        function cambiarCantidad(index, cambio) {
            const item = carrito[index];
            const nuevaCantidad = item.cantidad + cambio;

            if (nuevaCantidad <= 0) {
                eliminarDelCarrito(index);
            } else if (nuevaCantidad <= item.stockDisponible) {
                item.cantidad = nuevaCantidad;
                actualizarCarrito();
            } else {
                alert('No hay suficiente stock disponible');
            }
        }

        // Eliminar del carrito
        function eliminarDelCarrito(index) {
            carrito.splice(index, 1);
            actualizarCarrito();
        }

        // Calcular totales
        function calcularTotales() {
            const subtotal = carrito.reduce((sum, item) => sum + (item.cantidad * item.precioUnitario), 0);
            const igv = subtotal * 0.18;
            const total = subtotal + igv;

            document.getElementById('subtotalCarrito').textContent = `S/ ${subtotal.toFixed(2)}`;
            document.getElementById('igvCarrito').textContent = `S/ ${igv.toFixed(2)}`;
            document.getElementById('totalCarrito').textContent = `S/ ${total.toFixed(2)}`;
        }

        // Limpiar carrito
        function limpiarCarrito() {
            if (confirm('¿Desea limpiar el carrito?')) {
                carrito = [];
                actualizarCarrito();
            }
        }

        // Procesar venta
        function procesarVenta() {
            if (carrito.length === 0) {
                alert('El carrito está vacío');
                return;
            }

            const clienteId = document.getElementById('clienteVenta').value;
            const metodoPago = document.getElementById('metodoPago').value;

            const ventaData = {
                idUsuario: 1, // Se debe obtener del usuario autenticado
                idCliente: clienteId ? parseInt(clienteId) : null,
                metodoPago: metodoPago,
                detalles: carrito.map(item => ({
                    idProducto: item.idProducto,
                    cantidad: item.cantidad,
                    precioUnitario: item.precioUnitario
                }))
            };

            fetch('/ventas/api', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(ventaData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('¡Venta procesada exitosamente!\nN° Venta: ' + data.venta.numeroVenta);
                    limpiarCarrito();
                    cargarProductos();
                    cargarHistorialVentas();
                    document.getElementById('historial-tab').click();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al procesar la venta');
            });
        }

        // Cargar historial de ventas
        function cargarHistorialVentas() {
            fetch('/ventas/api')
                .then(response => response.json())
                .then(ventas => {
                    const tbody = document.getElementById('historialVentas');
                    tbody.innerHTML = '';

                    ventas.forEach(venta => {
                        const tr = document.createElement('tr');
                        const fecha = new Date(venta.fechaVenta).toLocaleString('es-PE');
                        const estadoBadge = venta.estado === 'COMPLETADA' ? 'bg-success' : 'bg-danger';
                        
                        tr.innerHTML = `
                            <td>${venta.numeroVenta}</td>
                            <td>${fecha}</td>
                            <td>${venta.cliente ? venta.cliente.nombreCompleto : 'Cliente General'}</td>
                            <td><strong>S/ ${venta.total.toFixed(2)}</strong></td>
                            <td>${venta.metodoPago}</td>
                            <td><span class="badge ${estadoBadge}">${venta.estado}</span></td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="verDetalles(${venta.idVenta})">
                                    <i class="bi bi-eye"></i>
                                </button>
                                ${venta.estado === 'COMPLETADA' ? `
                                <button class="btn btn-sm btn-danger" onclick="anularVenta(${venta.idVenta})" sec:authorize="hasRole('ADMIN')">
                                    <i class="bi bi-x-circle"></i>
                                </button>` : ''}
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                });
        }

        // Ver detalles de venta
        function verDetalles(idVenta) {
            fetch(`/ventas/api/${idVenta}/detalles`)
                .then(response => response.json())
                .then(detalles => {
                    const body = document.getElementById('detallesVentaBody');
                    let html = '<table class="table table-sm"><thead><tr><th>Producto</th><th>Cantidad</th><th>Precio</th><th>Subtotal</th></tr></thead><tbody>';
                    
                    detalles.forEach(d => {
                        html += `
                            <tr>
                                <td>${d.producto.nombreProducto}</td>
                                <td>${d.cantidad}</td>
                                <td>S/ ${d.precioUnitario.toFixed(2)}</td>
                                <td>S/ ${d.subtotal.toFixed(2)}</td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table>';
                    body.innerHTML = html;
                    
                    new bootstrap.Modal(document.getElementById('modalDetalles')).show();
                });
        }

        // Anular venta
        function anularVenta(idVenta) {
            if (!confirm('¿Está seguro de anular esta venta? El stock se devolverá.')) return;

            fetch(`/ventas/api/${idVenta}/anular`, { method: 'PATCH' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Venta anulada exitosamente');
                        cargarHistorialVentas();
                        cargarProductos();
                    } else {
                        alert('Error: ' + data.message);
                    }
                });
        }

        // Filtrar por fecha
        function filtrarPorFecha() {
            const inicio = document.getElementById('fechaInicio').value;
            const fin = document.getElementById('fechaFin').value;

            if (!inicio || !fin) {
                alert('Debe seleccionar ambas fechas');
                return;
            }

            fetch(`/ventas/api/reportes/por-fecha?fechaInicio=${inicio}&fechaFin=${fin}`)
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('historialVentas');
                    tbody.innerHTML = '';

                    data.ventas.forEach(venta => {
                        const tr = document.createElement('tr');
                        const fecha = new Date(venta.fechaVenta).toLocaleString('es-PE');
                        const estadoBadge = venta.estado === 'COMPLETADA' ? 'bg-success' : 'bg-danger';
                        
                        tr.innerHTML = `
                            <td>${venta.numeroVenta}</td>
                            <td>${fecha}</td>
                            <td>${venta.cliente ? venta.cliente.nombreCompleto : 'Cliente General'}</td>
                            <td><strong>S/ ${venta.total.toFixed(2)}</strong></td>
                            <td>${venta.metodoPago}</td>
                            <td><span class="badge ${estadoBadge}">${venta.estado}</span></td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="verDetalles(${venta.idVenta})">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });

                    alert(`Total ventas: S/ ${data.total.toFixed(2)}\nCantidad: ${data.cantidad}`);
                });
        }

        function mostrarNuevaVenta() {
            document.getElementById('nueva-tab').click();
        }

        // Event listener para búsqueda en tiempo real
        document.getElementById('buscarProducto').addEventListener('input', buscarProductos);
    </script>
</body>
</html>
