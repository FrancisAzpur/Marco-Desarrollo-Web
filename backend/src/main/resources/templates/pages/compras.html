<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compras - ShopTrust</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/inicio"><i class="bi bi-shop"></i> ShopTrust</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="/inicio">Inicio</a></li>
                    <li class="nav-item"><a class="nav-link" href="/ventas">Ventas</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/compras">Compras</a></li>
                    <li class="nav-item"><a class="nav-link" href="/productos">Productos</a></li>
                    <li class="nav-item"><a class="nav-link" href="/clientes">Clientes</a></li>
                    <li class="nav-item"><a class="nav-link" href="/proveedores">Proveedores</a></li>
                    <li class="nav-item"><a class="nav-link" href="/categorias">Categorías</a></li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <span class="nav-link"><i class="bi bi-person-circle"></i> <span sec:authentication="name">Usuario</span></span>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/logout"><i class="bi bi-box-arrow-right"></i> Salir</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-md-8">
                <h2><i class="bi bi-box-seam"></i> Gestión de Compras</h2>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-success" onclick="mostrarNuevaCompra()">
                    <i class="bi bi-plus-circle"></i> Nueva Compra
                </button>
            </div>
        </div>

        <!-- Pestañas -->
        <ul class="nav nav-tabs mt-3" id="comprasTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="nueva-tab" data-bs-toggle="tab" data-bs-target="#nueva-compra" 
                        type="button" role="tab">Nueva Compra</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="historial-tab" data-bs-toggle="tab" data-bs-target="#historial" 
                        type="button" role="tab">Historial de Compras</button>
            </li>
        </ul>

        <div class="tab-content mt-3" id="comprasTabContent">
            <!-- TAB: Nueva Compra -->
            <div class="tab-pane fade show active" id="nueva-compra" role="tabpanel">
                <div class="row">
                    <!-- Panel de Búsqueda de Productos -->
                    <div class="col-md-7">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0"><i class="bi bi-search"></i> Buscar Productos</h5>
                            </div>
                            <div class="card-body">
                                <div class="input-group mb-3">
                                    <input type="text" id="buscarProducto" class="form-control" 
                                           placeholder="Buscar por nombre o código...">
                                    <button class="btn btn-outline-secondary" type="button" onclick="buscarProductos()">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>

                                <div id="listaProductos" class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                    <table class="table table-hover table-sm">
                                        <thead class="table-light sticky-top">
                                            <tr>
                                                <th>Código</th>
                                                <th>Producto</th>
                                                <th>Stock Actual</th>
                                                <th>P. Compra</th>
                                                <th>Acción</th>
                                            </tr>
                                        </thead>
                                        <tbody id="productosBody">
                                            <!-- Se llena con JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Panel de la Orden de Compra -->
                    <div class="col-md-5">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="bi bi-clipboard-check"></i> Orden de Compra</h5>
                            </div>
                            <div class="card-body">
                                <!-- Selección de Proveedor -->
                                <div class="mb-3">
                                    <label class="form-label"><span class="text-danger">*</span> Proveedor</label>
                                    <select id="proveedorCompra" class="form-select form-select-sm" required>
                                        <option value="">Seleccionar proveedor...</option>
                                        <option th:each="proveedor : ${proveedores}" 
                                                th:value="${proveedor.idProveedor}"
                                                th:text="${proveedor.nombreEmpresa}"></option>
                                    </select>
                                </div>

                                <!-- Observaciones -->
                                <div class="mb-3">
                                    <label class="form-label">Observaciones</label>
                                    <textarea id="observaciones" class="form-control form-control-sm" rows="2" 
                                              placeholder="Notas adicionales..."></textarea>
                                </div>

                                <!-- Items de la Orden -->
                                <div id="ordenItems" style="max-height: 200px; overflow-y: auto;">
                                    <p class="text-muted text-center" id="ordenVacia">La orden está vacía</p>
                                </div>

                                <!-- Totales -->
                                <hr>
                                <div class="row mb-2">
                                    <div class="col">Subtotal:</div>
                                    <div class="col text-end"><strong id="subtotalOrden">S/ 0.00</strong></div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col">IGV (18%):</div>
                                    <div class="col text-end"><strong id="igvOrden">S/ 0.00</strong></div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col"><h5>Total:</h5></div>
                                    <div class="col text-end"><h5 class="text-success" id="totalOrden">S/ 0.00</h5></div>
                                </div>

                                <!-- Botones -->
                                <div class="d-grid gap-2">
                                    <button class="btn btn-success" onclick="procesarCompra()" id="btnProcesar">
                                        <i class="bi bi-check-circle"></i> Registrar Compra
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="limpiarOrden()">
                                        <i class="bi bi-x-circle"></i> Limpiar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: Historial de Compras -->
            <div class="tab-pane fade" id="historial" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <div class="row">
                            <div class="col-md-6">
                                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Historial de Compras</h5>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group input-group-sm">
                                    <input type="date" id="fechaInicio" class="form-control">
                                    <input type="date" id="fechaFin" class="form-control">
                                    <button class="btn btn-primary" onclick="filtrarPorFecha()">
                                        <i class="bi bi-filter"></i> Filtrar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>N° Compra</th>
                                        <th>Fecha</th>
                                        <th>Proveedor</th>
                                        <th>Total</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="historialCompras">
                                    <!-- Se llena con JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ver Detalles -->
    <div class="modal fade" id="modalDetalles" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="bi bi-receipt"></i> Detalles de Compra</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detallesCompraBody">
                    <!-- Se llena con JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Agregar Producto -->
    <div class="modal fade" id="modalAgregarProducto" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Agregar Producto a la Compra</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="productoSeleccionadoId">
                    <div class="mb-3">
                        <label class="form-label"><strong>Producto:</strong></label>
                        <p id="productoSeleccionadoNombre" class="form-control-plaintext"></p>
                    </div>
                    <div class="mb-3">
                        <label for="cantidadCompra" class="form-label">Cantidad</label>
                        <input type="number" class="form-control" id="cantidadCompra" min="1" value="1" required>
                    </div>
                    <div class="mb-3">
                        <label for="precioCompra" class="form-label">Precio de Compra Unitario</label>
                        <div class="input-group">
                            <span class="input-group-text">S/</span>
                            <input type="number" class="form-control" id="precioCompra" step="0.01" min="0.01" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="confirmarAgregarProducto()">
                        <i class="bi bi-check"></i> Agregar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables globales
        let orden = [];
        let productos = [];
        let modalAgregar = null;
        let modalDetalles = null;

        // Cargar datos iniciales
        document.addEventListener('DOMContentLoaded', function() {
            cargarProductos();
            cargarHistorialCompras();
            
            // Inicializar modales
            modalAgregar = new bootstrap.Modal(document.getElementById('modalAgregarProducto'));
            modalDetalles = new bootstrap.Modal(document.getElementById('modalDetalles'));
            
            // Establecer fecha de hoy en filtros
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('fechaInicio').value = hoy;
            document.getElementById('fechaFin').value = hoy;
        });

        // Cargar productos
        function cargarProductos() {
            fetch('/productos/api')
                .then(response => response.json())
                .then(data => {
                    productos = data.filter(p => p.activo);
                    mostrarProductos(productos);
                });
        }

        // Mostrar productos en tabla
        function mostrarProductos(lista) {
            const tbody = document.getElementById('productosBody');
            tbody.innerHTML = '';

            lista.forEach(producto => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${producto.codigoProducto}</td>
                    <td>${producto.nombreProducto}</td>
                    <td><span class="badge ${producto.stockActual <= producto.stockMinimo ? 'bg-warning' : 'bg-info'}">${producto.stockActual}</span></td>
                    <td>S/ ${producto.precioCompra.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="mostrarModalAgregar(${producto.idProducto})">
                            <i class="bi bi-plus"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Buscar productos
        function buscarProductos() {
            const termino = document.getElementById('buscarProducto').value.toLowerCase();
            const filtrados = productos.filter(p => 
                p.nombreProducto.toLowerCase().includes(termino) ||
                p.codigoProducto.toLowerCase().includes(termino)
            );
            mostrarProductos(filtrados);
        }

        // Mostrar modal para agregar producto
        function mostrarModalAgregar(idProducto) {
            const producto = productos.find(p => p.idProducto === idProducto);
            if (!producto) return;

            document.getElementById('productoSeleccionadoId').value = idProducto;
            document.getElementById('productoSeleccionadoNombre').textContent = producto.nombreProducto;
            document.getElementById('cantidadCompra').value = 1;
            document.getElementById('precioCompra').value = producto.precioCompra.toFixed(2);

            modalAgregar.show();
        }

        // Confirmar agregar producto
        function confirmarAgregarProducto() {
            const idProducto = parseInt(document.getElementById('productoSeleccionadoId').value);
            const cantidad = parseInt(document.getElementById('cantidadCompra').value);
            const precio = parseFloat(document.getElementById('precioCompra').value);

            if (!cantidad || cantidad <= 0) {
                alert('Ingrese una cantidad válida');
                return;
            }

            if (!precio || precio <= 0) {
                alert('Ingrese un precio válido');
                return;
            }

            const producto = productos.find(p => p.idProducto === idProducto);
            const itemExistente = orden.find(item => item.idProducto === idProducto);

            if (itemExistente) {
                itemExistente.cantidad += cantidad;
                itemExistente.precioUnitario = precio;
            } else {
                orden.push({
                    idProducto: producto.idProducto,
                    nombreProducto: producto.nombreProducto,
                    precioUnitario: precio,
                    cantidad: cantidad
                });
            }

            actualizarOrden();
            modalAgregar.hide();
        }

        // Actualizar orden
        function actualizarOrden() {
            const container = document.getElementById('ordenItems');
            const ordenVacia = document.getElementById('ordenVacia');

            if (orden.length === 0) {
                ordenVacia.style.display = 'block';
                container.innerHTML = '<p class="text-muted text-center" id="ordenVacia">La orden está vacía</p>';
            } else {
                ordenVacia.style.display = 'none';
                container.innerHTML = '';

                orden.forEach((item, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'border-bottom pb-2 mb-2';
                    itemDiv.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="flex-grow-1">
                                <small><strong>${item.nombreProducto}</strong></small><br>
                                <small class="text-muted">S/ ${item.precioUnitario.toFixed(2)} c/u × ${item.cantidad}</small>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <button class="btn btn-sm btn-danger" onclick="eliminarDeOrden(${index})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="text-end mt-1">
                            <strong>S/ ${(item.cantidad * item.precioUnitario).toFixed(2)}</strong>
                        </div>
                    `;
                    container.appendChild(itemDiv);
                });
            }

            calcularTotales();
        }

        // Eliminar de orden
        function eliminarDeOrden(index) {
            orden.splice(index, 1);
            actualizarOrden();
        }

        // Calcular totales
        function calcularTotales() {
            const subtotal = orden.reduce((sum, item) => sum + (item.cantidad * item.precioUnitario), 0);
            const igv = subtotal * 0.18;
            const total = subtotal + igv;

            document.getElementById('subtotalOrden').textContent = `S/ ${subtotal.toFixed(2)}`;
            document.getElementById('igvOrden').textContent = `S/ ${igv.toFixed(2)}`;
            document.getElementById('totalOrden').textContent = `S/ ${total.toFixed(2)}`;
        }

        // Limpiar orden
        function limpiarOrden() {
            if (confirm('¿Desea limpiar la orden de compra?')) {
                orden = [];
                actualizarOrden();
            }
        }

        // Procesar compra
        function procesarCompra() {
            if (orden.length === 0) {
                alert('La orden está vacía');
                return;
            }

            const proveedorId = document.getElementById('proveedorCompra').value;
            if (!proveedorId) {
                alert('Debe seleccionar un proveedor');
                return;
            }

            const observaciones = document.getElementById('observaciones').value;

            const compraData = {
                idUsuario: 1, // Se debe obtener del usuario autenticado
                idProveedor: parseInt(proveedorId),
                observaciones: observaciones,
                detalles: orden.map(item => ({
                    idProducto: item.idProducto,
                    cantidad: item.cantidad,
                    precioUnitario: item.precioUnitario
                }))
            };

            fetch('/compras/api', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(compraData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('¡Compra registrada exitosamente!\nN° Compra: ' + data.compra.numeroCompra);
                    limpiarOrden();
                    document.getElementById('proveedorCompra').value = '';
                    document.getElementById('observaciones').value = '';
                    cargarProductos();
                    cargarHistorialCompras();
                    document.getElementById('historial-tab').click();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al procesar la compra');
            });
        }

        // Cargar historial de compras
        function cargarHistorialCompras() {
            fetch('/compras/api')
                .then(response => response.json())
                .then(compras => {
                    const tbody = document.getElementById('historialCompras');
                    tbody.innerHTML = '';

                    compras.forEach(compra => {
                        const tr = document.createElement('tr');
                        const fecha = new Date(compra.fechaCompra).toLocaleString('es-PE');
                        const estadoBadge = compra.estado === 'COMPLETADA' ? 'bg-success' : 'bg-danger';
                        
                        tr.innerHTML = `
                            <td>${compra.numeroCompra}</td>
                            <td>${fecha}</td>
                            <td>${compra.proveedor.nombreEmpresa}</td>
                            <td><strong>S/ ${compra.total.toFixed(2)}</strong></td>
                            <td><span class="badge ${estadoBadge}">${compra.estado}</span></td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="verDetalles(${compra.idCompra})">
                                    <i class="bi bi-eye"></i>
                                </button>
                                ${compra.estado === 'COMPLETADA' ? `
                                <button class="btn btn-sm btn-danger" onclick="anularCompra(${compra.idCompra})" sec:authorize="hasRole('ADMIN')">
                                    <i class="bi bi-x-circle"></i>
                                </button>` : ''}
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                });
        }

        // Ver detalles de compra
        function verDetalles(idCompra) {
            fetch(`/compras/api/${idCompra}/detalles`)
                .then(response => response.json())
                .then(detalles => {
                    const body = document.getElementById('detallesCompraBody');
                    let html = '<table class="table table-sm"><thead><tr><th>Producto</th><th>Cantidad</th><th>Precio</th><th>Subtotal</th></tr></thead><tbody>';
                    
                    detalles.forEach(d => {
                        html += `
                            <tr>
                                <td>${d.producto.nombreProducto}</td>
                                <td>${d.cantidad}</td>
                                <td>S/ ${d.precioUnitario.toFixed(2)}</td>
                                <td>S/ ${d.subtotal.toFixed(2)}</td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table>';
                    body.innerHTML = html;
                    
                    modalDetalles.show();
                });
        }

        // Anular compra
        function anularCompra(idCompra) {
            if (!confirm('¿Está seguro de anular esta compra? El stock se descontará.')) return;

            fetch(`/compras/api/${idCompra}/anular`, { method: 'PATCH' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Compra anulada exitosamente');
                        cargarHistorialCompras();
                        cargarProductos();
                    } else {
                        alert('Error: ' + data.message);
                    }
                });
        }

        // Filtrar por fecha
        function filtrarPorFecha() {
            const inicio = document.getElementById('fechaInicio').value;
            const fin = document.getElementById('fechaFin').value;

            if (!inicio || !fin) {
                alert('Debe seleccionar ambas fechas');
                return;
            }

            fetch(`/compras/api/reportes/por-fecha?fechaInicio=${inicio}&fechaFin=${fin}`)
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('historialCompras');
                    tbody.innerHTML = '';

                    data.compras.forEach(compra => {
                        const tr = document.createElement('tr');
                        const fecha = new Date(compra.fechaCompra).toLocaleString('es-PE');
                        const estadoBadge = compra.estado === 'COMPLETADA' ? 'bg-success' : 'bg-danger';
                        
                        tr.innerHTML = `
                            <td>${compra.numeroCompra}</td>
                            <td>${fecha}</td>
                            <td>${compra.proveedor.nombreEmpresa}</td>
                            <td><strong>S/ ${compra.total.toFixed(2)}</strong></td>
                            <td><span class="badge ${estadoBadge}">${compra.estado}</span></td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="verDetalles(${compra.idCompra})">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });

                    alert(`Total compras: S/ ${data.total.toFixed(2)}\nCantidad: ${data.cantidad}`);
                });
        }

        function mostrarNuevaCompra() {
            document.getElementById('nueva-tab').click();
        }

        // Event listener para búsqueda en tiempo real
        document.getElementById('buscarProducto').addEventListener('input', buscarProductos);
    </script>
</body>
</html>
